---
parameters:
  - name: module_path
    type: string
  - name: run_type
    type: string

steps:
  - task: Bash@3
    displayName: "[terraform init]"
    inputs:
      targetType: "inline"
      script: "make tf-init"
    env:
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      TEST_MODULE_PATH: "${{ parameters.module_path }}"
    condition: and(succeeded(), in('${{ parameters.run_type }}', 'unit', 'e2e', 'destroy'))

  - task: AzureCLI@2
    displayName: "[terraform plan]"
    inputs:
      scriptType: bash
      scriptLocation: scriptPath
      scriptPath: "tests/scripts/tf-plan.sh"
      failOnStandardError: true
      addSpnToEnvironment: true
      azureSubscription: ES-TestFramework-Job1
      workingDirectory: "$(System.DefaultWorkingDirectory)"
    env:
      TEST_MODULE_PATH: "${{ parameters.module_path }}"
    condition: and(succeeded(), in('${{ parameters.run_type }}', 'unit'))

  - task: AzureCLI@2
    displayName: "[terraform apply]"
    inputs:
      scriptType: bash
      scriptLocation: scriptPath
      failOnStandardError: true
      addSpnToEnvironment: true
      scriptPath: "tests/scripts/tf-apply.sh"
      azureSubscription: ES-TestFramework-Job2
      workingDirectory: "$(System.DefaultWorkingDirectory)"
    env:
      TEST_MODULE_PATH: "${{ parameters.module_path }}"
    condition: and(succeeded(), eq('${{ parameters.run_type }}', 'e2e'))

  - task: AzureCLI@2
    displayName: "[terraform destroy]"
    inputs:
      scriptType: bash
      scriptLocation: scriptPath
      failOnStandardError: true
      addSpnToEnvironment: true
      scriptPath: "tests/scripts/tf-destroy.sh"
      azureSubscription: ES-TestFramework-Job3
      workingDirectory: "$(System.DefaultWorkingDirectory)"
    env:
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      TEST_MODULE_PATH: "${{ parameters.module_path }}"
    condition: and(succeeded(), eq('${{ parameters.run_type }}', 'destroy'))
